#!/usr/bin/env bash

SCRIPT_NAME=$(basename "$0")

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

CONFIG_FILE="$HOME/.syc.cfg"

print_info()   { echo -e "${GREEN}[INFO]${NC} $1"; }
print_error()  { echo -e "${RED}[ERROR]${NC} $1"; }
print_warning(){ echo -e "${YELLOW}[WARNING]${NC} $1"; }

REMOTE_HOST=""
DRY_RUN=false

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help) usage; return 0 ;;
    -c|--config) CONFIG_FILE="$2"; shift 2 ;;
    -n|--dry-run) DRY_RUN=true; shift ;;
    *) [[ -z "$REMOTE_HOST" ]] && REMOTE_HOST="$1" || { print_error "多余参数"; return 1; }; shift ;;
  esac
done

[[ -z "$REMOTE_HOST" ]] && print_error "缺少远程主机" && return 1
[[ ! -f "$CONFIG_FILE" ]] && print_error "配置文件不存在" && return 1

SUCCESS=0
FAIL=0
SKIP=0

print_info "开始同步文件到 $REMOTE_HOST ..."
echo "----------------------------------------"

while IFS= read -r raw; do
  [[ -z "$raw" || "$raw" =~ ^[[:space:]]*# ]] && continue

  # 展开 ~
  pattern="${raw/#\~/$HOME}"

  # 分解路径
  dir=$(dirname "$pattern")
  base=$(basename "$pattern")

  if [[ $raw = *\** ]]; then
    find "$dir" -maxdepth 1 -name "$base" 2>/dev/null
  else
    echo $pattern
  fi

done < "$CONFIG_FILE" | while read -r f; do
  if [[ "$f" == "$HOME"* ]]; then
    rel="${f#$HOME/}"
    dest="~/$rel"
  else
    dest="$f"
  fi

  print_info "同步: $f → $REMOTE_HOST:$dest"
  
  if $DRY_RUN; then
    echo "[模拟] scp -r $f $REMOTE_HOST:$dest"
    ((SUCCESS++))
    continue
  fi

  remote_parent=$(dirname "$dest")
  if [[ ! "$remote_parent" = "~" ]]; then
    ssh "$REMOTE_HOST" "mkdir -p $remote_parent" </dev/null
  fi

  if scp -r "$f" "$REMOTE_HOST:$remote_parent"; then
    ((SUCCESS++))
  else
    print_error "同步失败: $f"
    ((FAIL++))
  fi
  
  echo ""

done

echo "----------------------------------------"
print_info "成功: $SUCCESS | 失败: $FAIL | 跳过: $SKIP"

