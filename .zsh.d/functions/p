#!/usr/bin/env bash

SCRIPT_NAME=$(basename "$0")

##############
### config ###
##############

declare -A COLOR=(
  [reset]=""
  [green]=""
  [yellow]=""
  [red]=""
  [blue]=""
  [bold]=""
  [bold_off]=""
)

if [[ -t 1 && -z "$NO_COLOR" ]]; then
  COLOR[reset]=$'\e[0m'
  COLOR[green]=$'\e[32m'
  COLOR[yellow]=$'\e[33m'
  COLOR[red]=$'\e[31m'
  COLOR[blue]=$'\e[34m'
  COLOR[bold]=$'\e[1m'
  COLOR[bold_off]=$'\e[22m'
fi

usage() {
  cat << EOF
Usage: $SCRIPT_NAME [OPTIONS] [NAME]

Set or manage tmux pane names:
  tsp "my-name"     Set current pane name
  tsp PANE_ID NAME  Set specific pane name (shorthand)
  tsp -d            Delete current pane name  
  tsp -D            Delete all pane names
  tsp -t ID NAME    Set specific pane name
  tsp -l            List all panes with names
  tsp -h|--help     Show this help

Examples:
  tsp "web-server"
  tsp -t 1 "database" 
  tsp -u
EOF
}

logger() {
  local level="$1"
  shift

  local color_reset="${COLOR[reset]}"
  local color_level=""

  case "$level" in
  INFO) color_level="${COLOR[blue]}" ;;
  OK) color_level="${COLOR[green]}" ;;
  WARN) color_level="${COLOR[yellow]}" ;;
  ERROR) color_level="${COLOR[red]}" ;;
  *) color_level="" ;;
  esac

  printf '[%s%s%s] %s\n' "$color_level" "$level" "$color_reset" "$*"
}

############
### main ###
############

check_tmux() {
  if [[ -z "$TMUX" ]]; then
    logger ERROR "Not in a tmux session"
    return 1
  fi
}

# 列出所有 pane 及其名称
list_panes() {
  echo "Panes in current window:"
  tmux list-panes -F "#{pane_index}: #{pane_current_command} #{?@pane_name,(#{@pane_name}),}"
}

main() {
  check_tmux || return 1
  
  case "$1" in
  -h)
    usage
    ;;
  -d)
    local current_name
    current_name=$(tmux show -p @pane_name 2>/dev/null | cut -d' ' -f2-)
    if [[ -n "$current_name" ]]; then
      tmux set -u -p @pane_name
      logger OK "Unset current pane [$current_name]"
    else
      logger WARN "Current pane has no name set"
    fi
    ;;
  -D)
    local count=0 unset_names=()
    for pane_id in $(tmux list-panes -F "#{pane_index}"); do
      local pane_name
      pane_name=$(tmux show -p -t "$pane_id" @pane_name 2>/dev/null | cut -d' ' -f2-)
      if [[ -n "$pane_name" ]]; then
        tmux set -u -p -t "$pane_id" @pane_name
        unset_names+=("pane $pane_id: $pane_name")
        ((count++))
      fi
    done
    if [[ $count -gt 0 ]]; then
      logger OK "Unset $count pane(s):"
      printf "  %s\n" "${unset_names[@]}"
    else
      logger INFO "No pane names to unset"
    fi
    ;;
  -l | --list)
    list_panes
    ;;
  -t)
    if [[ $# -lt 3 ]]; then
      logger ERROR "-t requires pane ID and name"
      echo "Usage: $SCRIPT_NAME -t PANE_ID NAME" >&2
      return 1
    fi
    local pane_id="$2" name="$3"
    if validate_pane "$pane_id"; then
      tmux set -p -t "$pane_id" @pane_name "$name"
      echo "✓ Set pane $pane_id to [$name]"
    fi
    ;;
  "")
    logger ERROR "Name is required"
    usage
    return 1
    ;;
  -*)
    logger ERROR "Unknown option '$1'"
    usage
    return 1
    ;;
  *)
    if [[ "$1" =~ ^[0-9]+$ && $# -ge 2 ]]; then
      local pane_id="$1" name="$2"
      if validate_pane "$pane_id"; then
        tmux set -p -t "$pane_id" @pane_name "$name"
        logger OK "Set pane $pane_id to [$name]"
      fi
    elif [[ -n "$1" ]]; then
      tmux set -p @pane_name "$1"
      logger OK "Set current pane to [$1]"
    else
      logger ERROR "Empty name not allowed"
      return 1
    fi
    ;;
  esac
}

main "$@"
