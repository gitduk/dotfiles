#!/usr/bin/env zsh

function senv() {
  local venv_path=""
  local dir=""
  local venv_names=(".venv" "venv")

  # å¦‚æœç”¨æˆ·ä¼ å…¥äº†ä¸€ä¸ªç›®å½•ä½œä¸ºå‚æ•°
  if [[ -n "$1" && -d "$1" ]]; then
    if [[ -f "$1/bin/activate" ]]; then
      venv_path="$1"
    elif [[ -f "$1/pyvenv.cfg" && -f "$1/bin/activate" ]]; then
      venv_path="$1"
    else
      echo "âŒ Provided directory does not appear to be a valid Python virtual environment: $1"
      return 1
    fi
  else
    # æ²¡ä¼ å‚æ•°ï¼Œå¼€å§‹å‘ä¸ŠæŸ¥æ‰¾è™šæ‹Ÿç¯å¢ƒ
    dir=$PWD
    while [[ "$dir" != "/" ]]; do
      for name in $venv_names; do
        if [[ -f "$dir/$name/bin/activate" ]]; then
          venv_path="$dir/$name"
          break 2
        fi
      done
      for candidate in "$dir"/*; do
        if [[ -f "$candidate/pyvenv.cfg" && -f "$candidate/bin/activate" ]]; then
          venv_path="$candidate"
          break 2
        fi
      done
      dir=$(dirname "$dir")
    done
  fi

  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
  if [[ -n "$venv_path" ]]; then
    echo "ğŸ”¹ Activating virtual environment: $venv_path"
    source "$venv_path/bin/activate"
  else
    echo "âŒ No virtual environment found."
    return 1
  fi
}

senv "$@"

